# chapter 04-2 TCP와 UDP

전송계층에서 가장 중요한 프로토콜은 TCP와 UDP이다. 

TCP는 신뢰할 수 있는 통신을 위한 연결형 프로토콜이고, UDP는  TCP 보다는 신뢰성은 떨어지지만 비교적 빠른 통신이 가능한 비연결형 프로토콜이다. 

TCP와 UDP의 패킷 구조와 동작 원리에 대해 알아보자.
<br/>
<br/>

## TCP 통신단계와 세그먼트 구조

TCP통신은 세 단계로 나누면 아래와 같다. 

1. 연결 수립
2. 데이터 송수신
3. 연결종료
<br />

- TCP는 통신하기 전에 연결을 수립하고 통신이 끝나면 연결을 종료한다. 그리고 데이터 송수신 과정에서 재전송을을 통한 오류 제어, 흐름 제어, 혼잡 제어등의 기능을 제공한다.
- MSS 단위: Maximum Segment Size의 약자로, TCP를 전송할 수 있는 최대 페이로드 크기를 의미한다.
- MSS의 크기를 고려할 때 TCP 헤더 크기는 제외한다. 헤더의 크기까지 포함했던 단위인 MTU와는 대조적이다.
<img src="https://blog.kakaocdn.net/dn/18T43/btrgBmg94PP/wXkcVUy9C0bwbXBj5HXLHk/img.png" />
<br />

TCP의 기본 동작을 이해하기 위한 기본적인 필드들을 살펴보자.
<br />

**제어 비트**

제어비트는 기본적으로 8비트로 구성되어 있다. 각 자리의 비트는 각기 다른 의미를 가지는데 , TCP 기본 동작에서 제일 중요한 세 개의 제어비트는 아래와 같다.

- ACK: 세그먼트의 승인을 나타내기 위한 비트
- SYN: 연결을 수립하기 위한 비트
- FIN: 연결을 종료하기 위한 비트
<br />

**순서 번호와 확인 응답 번호**

순서 번호 필드와 확인 응답 번호 필드는  TCP의 신뢰성을 보장하기 위해 사용되는 중요한 필드로 한 쌍으로 묶어서 기억하는 것이 좋다.

- **순서 번호**:  순서 번호 필드에 명시되는 순서번호는 세그먼트의 올바른 송수신 순서를 보장하기 위한 번호로, 세그먼트 데이터의 첫 바이트에 부여되는 번호이다. 
순서번호는  초기 순서 번호 + 송신한 바이트 수 이며, 쉽게 말해 ‘초기 순서 번호 + 떨어진 바이트 수’ 라고 생각하는것이 좋다.
- **확인 응답 번호:** 확인 응답 번호 필드에 명시되는 확인 응답 번호는 순서 번호에 대한 응답이다. 
즉, 확인 응답 번호는 수신자가 다음으로 받기를 기대하는 순서 번호이며, 일반적으로 “수신한 순서 번호 + 1”로 설정된다.
<br />

## TCP 연결 수립과 종료

**연결 수립: 쓰리웨이 핸드셰이크**

TCP의 연결 수립은 쓰리 웨이 핸드셰이크를 통해 이루어진다. 쓰리 웨이 핸드셰이크는 세 개의 단계로 이루어진 TCP의 연결 수립 과정을 의미한다. 

- **액티브 오픈**:  처음 연결을 시작하는 호스트의 연결 수립 과정을 뜻한다. 액티브 오픈은 주로 서버 -클라이언트 통신에서 클라이언트에 의해 수행된다.
- **패시브 오픈**: 연결 요청을 받고 나서 요청에 따라 연결을 수립해주는 호스트를 뜻한다. 주로 서버에 의해서 수행된다.
<br />

**연결 종료**

쓰리웨이 핸드셰이크를 통해 연결을 수립한 뒤 데이터 송수신이 끝났다면, 연결을 종료해야 한다. 

TCP가 연결을 종료하는 과정은 송수신 호스트가 각자 한 번씩 FIN과 ACK를 주고받으며 이루어진다. 

- **액티브 클로즈**:  연결을 종료하려는 호스트에 의해 수행된다.
- **패시브 클로즈**:  연결 종료 요청을 받아들이는 호스트에 의해 수행된다.
<br />

## TCP 상태

TCP는 연결형 통신과 신뢰할 수 있는 통신을 유지하기 위해 다양한 “상태”를 유지한다. 상태는 현재 어떤 통신 과정에 있는지를 나타내는 정보이다. TCP는 상태를 유지하고 활용한다는 점에서 스테이트풀(stateful) 프로토콜이라고 부른다.

아래는 TCP의 상태이다. 

- 연결이 수립되지 않은 상태 : CLOSED, LISTEN
- 연결 수립 과정에서 주로 볼 수 있는 상태: SYN-SENT, SYN-RECEIVED, ESTABLISHED
- 연결 종료 과정에서 주로 볼 수 있는 상태: FIN-WAIT-1, CLOSED-WAIT, FIN-WAIT-2, LAST-ACK, TIME-WAIT, CLOSING
<br />

**연결이 수립되지 않은 상태** 

- **CLOSED**: 아무런 연결이 없는 상태
- **LISTEN**: 일종의 연결 대기 상태, 일반적으로 서버로서 동작하는 패시브 오픈 호스트는 LISTEN 상태를 유지한다.  즉, 액티브 오픈 호스트(클라이언트)가 LISTEN 상태인 호스트(서버)에게 SYN 세그먼트를 보내면 쓰리 웨이 핸드셰이크가 시작된다.
<br />

**연결 수립 상태**

- **SYN-SENT:** 액티브 오픈 호스트가  SYN 세그먼트를 보낸 뒤 그에 대한 응답인 SYN + ACK 세그먼트를 기다리는 상태이다. 연결 요청을 보낸 뒤 대기하는 상태이다.
- **SYN-RECEIVED:** 패시브 오픈 호스트가 SYN + ACK 세그먼트를 보낸 뒤 그에 대한 ACK 세그먼트를 기다리는 상태이다.
- **ESTABLISHED:** 연결이 확립되었음을 나타내는 상태이다. 데이터를 송수신할 수 있는 상태를 의미한다. 쓰리 웨이 핸드 셰이크 과정에서 두 호스트가 마지막 ACK 세그먼트를 주고받으면 ESTABLISHED 상태로 접어든다.
<br />

**연결 종료 상태**

- **FIN-WAIT-1 :** 일반적인 TCP 연결 종료 과정에 있어 FIN-WAIT-1은 연결 종료의 첫 단계가 된다. FIN 세그먼트로서 연결 종료 요청을 보낸 액티브 클로즈 호스트는 FIN-WAIT-1 상태로 접어든다.
- **CLOSE-WAIT :** 종료 요청인 FIN 세그먼트를 받은 패시브 클로즈 호스트가 그에 대한 응답으로 ACK 세그먼트를 보낸 후 대기하는 상태이다.
- **FIN-WAIT-2 :** FIN-WAIT-1 상태에서 ACK 세그먼트를 받게 되면 FIN-WAIT-2 T상태가 된다. 상대 호스트의 FIN 세그먼트를 기다리는 상태이다.
- **LAST-ACK** : CLOSE-WAIT 상태에서 FIN 세그먼트를 전송한 뒤 이에 대한 ACK 세그먼트를 기다리는 상태이다.
- **TIME-WAIT :** 액티브 클로즈 호스트가 FIN 세그먼트를 수신한 뒤, 이에 대한 ACK 세그먼트를 전송한 뒤 접어드는 상태이다. TIME-WAIT 상태에 접어든 액티브 클로즈 호스트는 일정 시간을 기다린 뒤 CLOSED  상태로 전이한다.
- **CLOSING :** 동시에 연결을 종료하려 할 때 전이되는 상태이다. 두 호스트 양쪽 모두가 연결 종료를 요청하고, 서로의 종료 응답을 기다리는 경우 CLOSING 상태로 접어든다.
<br />

## UDP 데이터그램 구조

UDP는 TCP와 달리 비연결형 통신을 수행하는 신뢰할 수 없는 프로토콜이다. 

연결 수립 해제, 재전송을 통한 오류 제어, 혼잡 제어, 흐름 제어 등을 수행하지 않는다. TCP처럼 상태를 유지하지도, 활용하지도 않아 UDP를 스테이트리스(stateless) 프로토콜의 일종이라고도 한다.
<br />

- **송신지 포트와 수신지 포트** : 송수신지의 포트 번호가 담긴다.
- **길이** : 헤더를 포함한 UDP 데이터그램의 바이트가 담긴다.
- **체크섬** : 데이터 그램 전송 과정에서 오류가 발생했는지 검사하기 위한 필드이다. 수신지는 이 필드의 값을 토대로 데이터그램의 정보가 훼손되었는지를 판단하고, 문제가 있다고 판단한 데이터 그램은 폐기한다.
<br />

✨UDP는 TCP에 비해 적은 오버헤드로 패킷을 빠르게 처리할 수 있다. 그래서 주로 실시간 스트리밍 서비스, 인터넷 전화처럼 실시간성이 강조되는 상황에서 TCP보다 더 많이 쓰인다.
