
# chapter 03-4 전송 계층 개요: IP의 한계와 포트
네트워크 계층과 응용 계층 사이에 위치한 전송 계층은 신뢰할 수 있는 통신과 연결형 통신을 기능하게 하여  IP의 한계를 극복하고, 포트 번호를  통해 응용계층의 애플리케이션 프로세스들을 식별하는 역할을 수행한다.
<br />
<br />

## 신뢰할 수 없는 통신과 비연결형 통신

네트워크 계층의 핵심 프로토콜인 IP는 크게 IP단편화와 IP 주소 지정을 한다. 하지만 IP는 두가지의 한계가 있다. 

바로 IP는 신뢰할 수 없는 프로토콜이자 비연결형 프로토콜이라는 점이다.  달리 표현하면, IP를 통한 패킷의 전달은 신뢰성이 없는 통신이자 연결을 수립하는 과정이 없는 통신이다. 이는 전송 계층이 존재하는 이유와도 직결되는 문제이다. 
<br />

- **신뢰할 수 없는 통신**이란 IP 프로토콜이 패킷의 수신지까지 제대로 전송되었다는 보장을 하지 않는 특징을 일컫는다. 통신 과정에서 패킷의 데이터가 손상되거나 중복된 패킷이 전송되었더라도, 확인하지 않고 재전송도 하지 않으며, 순성대로 패킷이 도착할 것도 보장할 수 없다는 의미이다. 

이러한 전송 특성을 다른 말로는 **최선형 전달** 이라고 부른다.
- **비연결형 통신**은 이름 그대로 송수신 호스트 간에 사전 연결 수립 작업을 거치지 않는 특징을 의미한다. 그저 수신지를 향해 패킷을 보내기만 한다.
<br />

**⇒ 그렇다면 IP는 왜 어떠한 보장도 없이 신뢰할 수 없는, 비연결형 통신을 할까?**

**주요한 이유는 성능 때문이다.** 모든 패킷이 전송되었는지 확인하고, 호스트 간에 연결을 수립하는 작업은 더 많은 시간, 대역폭, 부하가 요구되고 이는 곧 성능상 악영향으로 이어질 수 있다. 

인터넷 상에 패킷의 종류와 개수는 매우 다양한다. 그중에서 금융 서비스 처럼 반드시 신뢰성 있는 전송을 보장해야 하는 경우도 있지만, 동영상 스트리밍 서비스나 실시간 영상 통화처럼 한두 개의 패킷 손실은 감수하더라도 빠른 전송이 우선시되는 경우도 있다. 
<br />

## IP의 한계를 보완하는 전송 계층

전송계층이 어떻게 IP의 한계를 보완하는지 알아보자.
<br />

1. **전송 계층은 연결형 통신을 가능하게 한다.** 
- 연결형 통신을 지원하는 대표적인 전송 프로토콜로 TCP가 있다. TCP는 두 호스트가 정보를 주고받기 전에 마치 가상의 회선을 설정하듯이 연결을 수립한다.

1. **전송 계층은 신뢰성 있는 통신을 가능하게 한다.** 
- 신뢰성 있는 통신 또한 TCP를 통해 가능하다. TCP는 패킷이 수신지까지 올바른 순서대로 확실히 전달되는 것을 보장하기 위해 재전송을 통한 오류 제어, 흐름 제어, 혼잡 제어 등 다양한 기능들을 제공한다.
<br />

⇒ 앞서 설명한 것처럼 연결형 통신과 신뢰성 있는 통신이 비연결형 통신과 신뢰성 없는 통신에 비해 무조건 좋은 것만은 아니다. 때로는 성능을 위해 신뢰할 수 없는 통신, 비연결형 통신을 지원하는 프로토콜이 필요할 때가 있는데, 그럴때는 UDP라는 프로토콜을 사용할 수 있다.

UDP는 신뢰할 수 없는 통신, 비연결형 통신을 가능하게 하는 전송 계층의 프로토콜로 TCP보다는 비교적 빠른 전송이 가능하다. 
<br />

## 응용 계층과의 연결다리, 포트

**포트의 정의**

- 네트워크 외부에서 패킷을 전송할 때, 수신지 호스트의 주소까지 전달했다고 해서 전송이 끝난것이 아니다. 실행 중인 특정 애플리케이션 프로세스까지 전달되어야 하는데, 결국 패킷의 최종 수신 대상은 특정 애플리케이션 프로세스이다.
- 만약 어떤 패킷을 수신할 애플리케이션에 대한 정보가 패킷에 포함되어 있지 않다면 해당 패킷을 어떤 애플리케이션에 전달해야 할지 알 수 없다. 여기서 포트는 **실행중인 특정 어플리케이션을 식별할 수 있는 정보**를 말한다.
<br />

**포트의 분류**

- 전송계층에서는 포트 번호를 통해 특정 애플리케이션을 식별한다. 정확히는 패킷 내 수신지 포트와 송신지 포트를 통해 송수신지 호스트의 애플리케이션을 식별한다.
- TCP와 UDP는 모두 포트 번호 필드인 송수신지 포트 번호를 포함한다.
- 포트번호는 16비트로 표현 가능하며, 할당가능한 번호는 0번부터 시작해 65535번까지 총 65536개이다.
- 포트 번호는 번호의 범위에 따라 세종류로 나뉘는데, 각각 “잘 알려진 포트” , “등록된 포트”, “동적 포트”로 나뉜다.
- **잘 알려진 포트:  0 ~ 1023번까지 포트 번호는 잘 알려진 포트 이다. 시스템 포트라고도 불린다. 범용적으로 사용되는 프로토콜들을 말하는데, 대표적인 예시는 80(HTTP), 443(HTTPS)등이 있다.**
- **등록된 포트: 1024 ~ 49151번까지는 등록된 포트 번호 이다. 잘 알려진 포트에 비해서는 덜 범용적이지만ㅡ 흔히 사용된 애플리케이션 프로토콜에 할당하기 위해 사용된다. (1194 ⇒ openVPN, 3306 ⇒ MySQL 데이터 베이스)**
- **동적 포트: 49152 ~ 65535 번까지는 동적포트, 시설 포트, 임시 포트라고 부르는 포트 이다. 
인터넷 할당 번호 관리 기관에 의해 할당되 애플리케이션 프로토콜이 없고, 특별히 관리되지 않는 포트 번호인 만큼 자유롭게 사용할 수 있다.**
<br />

**⇒ 서버로서 동작하는 프로그램은 일반적으로 잘 알려진 포트나 등록된 포트로 동작하는 경우가 많다. 즉, 서버로서 동작하는 프로그램의 포트번호는 사전에 암묵적으로 정해진 경우가 많다. 

반면에 클라이언트로서 동작하는 프로그램은 동적 포트 번호 중에서 임의의 번호가 할당되는 경우가 많다. 대표적인 예시가 웹브라우저이다.** 

웹 브라우저 프로그램에는 동적 포트 냉의 임의의 포트 번호가 자동으로 할당된다.
<br />

✨ IP주소와 포트 번호에 대한 정보가 함께 주어지면 **특정 호스트에서 실행 중인 특정 애플리케이션 프로세스를 식별할 수 있다**. 그래서 포트번호는 일반적으로 **IP 주소: 포트 번호** 형식으로 IP 주소와 함께 표기되는 경우가 많다. (192.168.0.15: 8000)
<br />

## 포트 기반 NAT

NAT란 IP 주소를 변화하는 기술이며, 주로 네트워크 내부에서 사용되는 사설 IP 주소와 네트워크 외부에서 사용되는 공인 IP 주소를 변환하는데 사용된다.

변환을 위해 주로 사용되는 것이 NAT 변환 테이블이다.
<br />

**NAT 변환 테이블**

NAT 변환 테이블에는 변환의 대상이 되는 IP 주소 쌍이 명시되어 있다. 

오늘날 대중적으로 활용되는 NAT는 변환하고자 하는 IP 주소를 일대일로 대응하지 않는 경우가 많다. 오늘날 NAT 기술은 대부분 다수의 사설 IP 주소를 그보다 적은 수의 공인 IP주소로 변환한다.
<br />

**NAPT**

포트기반의 NAT를 NAPT라 한다. APT라고 부르기도 한다. 

NAPT는 포트를 활용해 하나의 공인 IP 주소를 여러 사설 IP주소가 공유할 수 있도록 하는  NAT의 일종이다. 

NAPT는 NAT 테이블에 변환될 IP 주소 쌍과 덩불어 포트 번호도 함께 기록된다.
