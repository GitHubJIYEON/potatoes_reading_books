# chapter 03-1 LAN을 넘어서는 네트워크 계층

LAN을 넘어서는 다른 네트워크와 통신하기 위한 네트워크 계층의 개념과 주요 프로토콜에 대해 알아보자.
<br/>
<br />

## 데이터 링크 계층의 한계

물리 계층과 데이터 링크 계층만으로 LAN을 넘어서 톻신하기 어렵다.

이유는 아래와 같다
<br/>

1. **물리 계층과 데이터 링크 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어렵다.**

- 물리 계층과 데이터 링크 계층은 기본적으로 LAN을 다루는 계층이지만, LAN에 속한 호스트끼리만 통신하지 않고 지구 반대편에 있는 호스토와도 통신이 가능하다. 서로 호스트가 도달하기까지는 수많은 네트워크 장비를 거치며 다양한 경로를 통해 이동해야한다.
- 이 중 패킷이 이동할 최적의 경로 (=도달 경로)를 결정하는 것을 라우팅이라고 하며, 라우팅은 물리 계층과 데이터 링크 계층으로는 수행할 수 없어서 네트워크 계층의 장비가 필요하다.
- 라우팅을 수행하는 대표적인 장비로는 라우터가 있다.
  <br />

2. **MAC 주소만으로는 모든 네트워크에 속한 호스트의 위치를 특정하기 어렵다.**

- 모든 호스트가 모든 네트워크에 속한 모든 호스트의 MAC 주소를 서로 알고 있기 어려워, MAC 주소만으로는 이 세상의 모든 호스트를 특정하기 어렵다.
- 택배를 예를 들면, 택배의 수신인 역할을 하는 정보가 MAC 주소라면, 수신지 역할을 하는 정보는 네트워크 계층의 IP 주소이다. 네트워크에서도 MAC 주소와 IP주소를 함께 사용하고, 기본적으로 IP주소를 우선적으로 활용한다.
- MAC 주소를 물리 주소라고 부르는 것처럼, IP 주소는 논리 주소라고도 불리며 ,IP 주소는 MAC 주소와 달리 호스트에 직접 할당이 가능하다. 또한, 한 호스트가 복수의 IP 주소를 가질 수도 있다.
  <br />

✏ 정리하자면, 물리 계층과 데이터 링크 계층만으로는 네트워크 간의 통신이 어렵고, 네트워크 계층이 다른 네트워크와의 통신을 가능하게 한다. 이는 IP 주소를 이용해 수신지 주소를 설정하거나, 해당 수신지까지의 최적의 경로를 결정하는 라우팅이 네트워크 계층에서 이루어지기 때문이다.
<br />
<br />

## 인터넷 프로토콜(IP)

**네트워크 계층의 가장 핵심적인 프로토콜은 인터넷 프로토콜(IP)이다.**
IP는 IP4와 IP6 두가지의 버전이 있는데, 일반적으로 IP를 얘기할 때는 IP4버전을 의미하는 경우가 많다. IP4를 중심으로 살펴보자.
<br />

**IP 주소 형태**

- IP 주소는 4바이트(32비트)로 주소를 표현할 수 있고, 숫자당 8비트로 표현되기에 0~255범위 안에 있는 네 개의 10진수로 표기된다.
- **EX. IPv4주소 ⇒ 192.168.1.1**
  <br />

**IP의 기능**

- IP의 대표적인 기능에는 **IP 주소 지정**과 **IP 단편화** 두 가지가 있다.
- **IP 주소 지정은 IP 주소를 바탕으로 송수신 대상을 지정하는 것을 의미**한다.
- **IP 단편화는 전송하고자 하는 패킷의 크기가 MTU라는 최대 전송 단위보다 클 경우, 이를 MTU크기 이하의 복수 패킷으로 나누는 것을 의미**한다.
- **MTU는 한 번에 전송가능한 패킷의 최대 크기를 의미**하며, IP 패킷의 해더도 MTU에 포함된다.
- MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합된다.
  <br />

### **IPv4**

IPv4의 패킷은 프레임의 페이로드로 데이터 필드에 명시된다. 모든 필드 중에 가장 핵심이 되는 필드는 식별자, 플래그, 단편화 오프셋, TTL, 프로토콜, 송신지 IP주소, 수신지 IP 주소 총 7개 이다.

각, 필드에 대해 알아보자.
<br />

1. **식별자**

- 패킷에 할당된 번호이다.
- 메시지 전송 과정에서 패킷이 여러 조각으로 쪼개져 전송되었다면 수신지에서는 이를 재조합해야하는데, 이때 쪼개져서 수신지에 도착한 패킷들이 어떤 메시지에서부터 쪼개졌는지 인식하기 위해 식별자를 사용한다.
  <br />

2. **플래그**

- 플래그는 총 세 개의 비트로 구성된 필드이다.
- 첫 번째 비트는 항상 0으로 예약된 비트이며 현재 사용하지는 않는다.
- 두 번째 비트는 DF라는 이름이 붙은 비트이며, IP 단편화의 수행 가능 여부를 표시한다. 만일 이 비트가 1로 설정되었다면 IP 단편화를 수행하지 않고, 0으로 설정되어있다면 수행이 가능하다.
- 세 번째 비트는 MF라는 비트이다. 단편화된 패킷이 더 있는지를 나타낸다. 만일 0 이라면 해당 패킷이 마지막 패킷임을 의미하고, 1이라면 쪼개진 패킷이 더 있다는 것을 의미한다.
  <br />

3. **단편화 오프셋**

- 단편화되어 전송되는 패킷들은 수신지에 순서대로 도착하지 않을 수 있기에, 패킷들을 순서대로 재조합하려면 단편화된 패킷이 초기 데이터에서 몇 번째 데이터에 해당하는 패킷인지 알아야 한다.
- 단편화 오프셋은 패킷이 단편화되기 전에 패킷의 초기 데이터에서 몇 번째로 떨어진 패킷인지를 나타낸다.
  <br />

4. **TTL**

- 패킷의 수명을 의미하며, 멀리 떨어진 호스트끼리 통신할 대 패킷은 여러 라우터를 거쳐 이동하는데, 패킷이 하나의 라우터를 거칠때마다 TTL이 1씩 감소되며 TTL 값이 0으로 떨어진 패킷은 폐기된다.
- TTL 필드의 존재 이유는 무의미한 패킷이 네트워크 상에 지속적으로 남아있는 것을 방지하기 위함이다.
  <br />

5. **프로토콜**

- IP 패킷의 프로토콜은 상위 계층의 프로토콜이 무엇인지를 나타내는 필드이다.
- 예를 들어 대표적인 전송 계층의 프로토콜인 TCP는 6번, UDP는 17번이다.
  <br />

6. **송신지 IP주소와 수신지 IP주소**

- 이름 그대로 송수신지의 IPv4 주소를 알 수 있다.
  <br />

✏ **요약하자면, IPv4는 식별자, 플래그, 단편화 오프셋으로 단편화와 재조합을 할 수 있고, 프로토콜 필드로 상위 계층 프로토콜을 알 수 있으며, TTL로 패킷의 남은 수명을 파악할 수 있다.**

**또한 송신지 IP 주소, 수신지 IP 주소를 통해 IP주소를 지정할 수 있다.**
<br />

### **IPv6**

- 이론적으로 할당 가능한 IPv4주소는 약 43억개(2의 32승) 이다. 전 세계 인구가 하나씩 IP주소를 가지고 있어도 부족한 숫자이다. 그런데 주변만 봐도
- IP주소를 가질 수 있는 장치가 스마트폰, 데스크톱, 노트북, 냉장고, TV등등 여러개이다. 결국 43억개라는 IPv4의 주소의 총량은 쉽게 고갈될 수 있다. 이런 이유로 IPv6가 등장했다.
- IPv6 주소는 16바이트(128비트)로 주소를 표현할 수 있도, 콜론으로 구분된 8개 그룹의 16진수로 표기된다. IPv6주소는 이론적으로 무한에 가까운 개수를 할당할 수 있다.
- **EX. IPv6주소 ⇒ 2001:0230:abcd:ffff:0000:0000:ffff:1111**
  <br />

IPv6는 IPv4에 비해 헤더가 간소화 되어 있다. 주요 필드는 다음 헤더, 홉 제한, 송신지 IP 주소, 수신지 IP 주소 총 네 개이다.

각, 필드에 대해 살펴보자.
<br />

1. **다음 헤더**

- 다음 헤더 필드는 상위 계층의 프로토콜을 가리키거나 확장 헤더를 가리킨다.
- IPv6는 추가적인 헤더 정보가 필요할 경우에 기본 헤더와 더불어 확장 헤더라는 추가 헤더를 가질 수 있다.
- 확장 헤더는 마치 꼬리에 꼬리를 물듯 또 다른 확장 헤더를 가질 수 있다.
  <br />

2. **홉 제한**

- 홉 제한 필드는 IPv4 패킷의 TTL 필드와 비슷하게 패킷의 수명을 나타내는 필드이다.
  <br />

3. **송신지 IP 주소와 수신지 IP 주소**

- 송신지 주소와 수신지 주소를 통해 IPv6 주소 지정이 가능하다.
  <br />

  **✏ 요약하자면, IP에는 버전 4와 6이 있고, 주소의 길이와 헤더의 구성이 다르다.**

**그리고 IPv6 또한 현재 유망한 프로토콜로 떠오르고 있는 만큼 다수의 장비에서 지원하지만, 아직까지는 일반적으로 IPv4가 많이 사용된다.**
<br />
<br />

## ARP

택배를 전송할 때 송신지 정보와 수신지 정보를 함께 명시하되 수신자보다는 수신지를 우선으로 고려하는 것처럼, MAC 주소와 IP주소는 함께 사용하지만, 기본적으로 IP 주소를 사용한다.

이 과정에서 **‘상대 호스트의 IP 주소는 알지만, MAC 주소는 알지 못하는 상황이 있을 때’** ARP라는 프로토콜을 사용한다.

- **ARP는 IP 주소를 통해 MAC 주소를 알아내는 프로토콜이다. 동일 네트워크 내에 있는 호스트의 IP 주소를 통해 MAC 주소를 알아낼 수 있다.**
- ARP의 동작 과정은 **ARP 요청 ⇒ ARP 응답 ⇒ ARP 테이블 갱신** 순으로 되어있다.
  <br />

1. **ARP 요청**

- 네트워크 내의 모든 호스트에게 브로드캐스트 메시지를 보낸다. 이때 브로드캐스트란 자신을 제외한 네트워크 상의 모든 호스트에게 전송하는 방식을 말한다.
  <br />

2. **ARP 응답**

- 네트워크 내의 모든 호스트가 ARP 요청 메시지를 수신하지만, MAC 주소를 알아내려는 특정 호스트는 자신의 주소가 아니므로 이를 무시한다.
- MAC 주소를 알아내려는 특정 호스트는 MAC 주소를 담은 메시지를 요청한 호스트에게 전송한다.
- 특정 호스트의 MAC 주소가 포함된 메시지를 수신한 호스트는 특정 호스트의 MAC 주소를 알게 된다.
- 메시지를 요청한 호스트에게 응답시에는 유니캐스트 메시지를 보내는데, 이때 유니캐스트란 하나의 수신지에 메시지를 전송하는 방식을 말한다.
  <br />

3. **ARP 테이블 갱신**

- ARP를 활용할 수 있는 모든 호스트는 ARP 테이블이라는 정보를 유지한다.
- ARP 테이블은 IP 주소와 그에 맞는 MAC 주소 테이블을 대응하는 표이다.
- ARP 요청 및 응답을 통해 특정 호스트의 MAC 주소를 알게 되면, 특정 호스트의 IP 주소와 MAC 주소의 연관 관계를 ARP 테이블에 추가한다.
- ARP 테이블은 일정 시간이 지나면 삭제되고, 임의로 삭제할 수도 있다.
  <br />

  🔎 **그렇다면 만일 통신하고자 하는 호스트 A,B 끼리 서로 다른 네트워크에 속해 있으면 어떻게 될까?**

⇒ 통신하고자 하는 호스트가 서로 다른 네트워크에 속해 있다면, 네트워크 외부로 나가기 위한 장비(라우터)의 MAC 주소를 알아내어 패킷을 전송한다.
<br />
<br />

**⭐ IP단편화를 피하는 방법**

IP의 대표적인 기능인 IP단편화는 되도록 수행되지 않는 것이 좋다. 데이터가 여러 패킷으로 쪼개지면 자연스레 전송해야할 패킷의 헤더들도 많아지고, 이는 불필요한 트래픽 증가와 대역폭 낭비로 이어질 수 있기 때문이다.

또한 쪼개진 IP 패킷들을 하나로 합치는 과정에서 발생하는 부하도 성능 저하를 야기할 수 있기에 IP 단편화는 가급적 피하는 것이 좋다.
<br />

**그렇다면 IP 단편화는 어떻게 피할까??**

**⇒ IP 패킷을 주고받는 모든 호스트의 ‘처리 가능한 MTU 크기’를 고려 해야 한다.**
<br />

예를 들어, 호스트 A,B가 여러 라우터를 거쳐 서로 IP 패킷을 주고받는다고 가정해보자.

호스트 A,B가 처리할 수 있는 MTU의 크기가 아무리 커도 라우터가 해당 MTU 크기를 지원하지 않으면 어쩔 수 없이 단편화를 해야 한다.

따라서 IP 단편화를 피하려면 ‘IP 단편화 없이 주고 받을 수 있는 최대 크기’ 만큼만 전송해야 한다. 이 크기를 경로 MTU라고 한다.

**다시 말해 IP 단편화를 피하는 방법은 경로 MTU 만큼의 데이터를 전송하는 것이다.**
<br />

**경로 MTU를 구하고 해당 크기만큼만 송수신하여 IP 단편화를 회피하는 기술을 경로 MTU 발견이라 한다. 오늘날 네트워크에서는 대부분 이를 지원하고, 처리 가능한 최대 MTU 크기도 대부분 균일하기 때문에 IP 단편화는 자주 수행되지 않는다.**
